# DB設計方針書

## 全テーブル共通事項
```
・本システムでは、すべての内部IDにBIGINT GENERATED ALWAYS AS IDENTITYを採用。
理由:
    - RDBのJOIN性能がUUIDより安定かつ高い
    - pgvector検索、JOINとの相性が良い
    - アプリケーション側での扱いが容易
    - 将来的なデータ量増加にも耐えうる設計

・テキストデータに対しては、長さがある程度予想できるものに関してはVARCHARを使用。
理由:
    - DB側で制限を設ける事で、想定外データの混入を防ぐ
    - 可読性の問題
    - 他DB, 他言語との互換性を考慮(将来的な事故防止)

・TIMESTAMPTZの基準はdocker-compose.ymlのenvironmentでも設定
理由:
    - JavaScript は日時を実行環境の timezone で解釈・表示するため、DB 側では TIMESTAMPTZ を使用し、timezone を Asia/Tokyo に設定している。これにより、日時は内部的には UTC で正規化して保存されるが、INSERT・SELECT・date_trunc 等の演算は JST 基準で行われる。その結果、フロントエンドでは 　getDate() 等のローカル日時 API を使用しても日付のズレが発生しない。

・JSONではなく**JSONB**を使用
理由:
    - JSONBは最初にパースされているので読み込みが速い
    - 部分更新も可能(JSONはすべて再書き込み)
    - 順序を保てないので人間が読むようなものには不向きだが、sess, metadata, contextであれば、データとしての取り扱いになるので問題ない
    - インデックスを貼れるので、全件捜査せずに対象行だけ検索できるので速い
```

## sessions (セッション管理)
```
・sid: TEXT COLLATE "C"

理由:
    - sid は意味的な順序を持たないランダムな識別子であり、
      人間向けの文字列比較（言語・文化依存の並び順）は不要である。
    - COLLATE "C" を指定することで、文字列比較をロケール非依存の
      バイト順比較に固定し、OS やロケール設定、将来の実行環境差があっても 常に同一の比較結果が得られる。

メモ:
    - sid は PRIMARY KEY のため B-tree インデックスが作成される。
    - 新しい sid が発行されると、B-tree 内のキーと大小比較を行いながら
      適切な位置に挿入される。
    - ユーザー認証時も、クライアントから送信された sid を用いて
      B-tree の境界キーと比較を繰り返し、一致する sid を探索する。
    - B-tree の探索・挿入ではノードを降りるたびに何十回〜何百回もの
      文字列比較が発生する。
    - ロケール依存の比較では、Unicode 正規化や大小文字規則、
      言語固有ルールなどを考慮するため比較コストが高い。
    - 一方、COLLATE "C" では単純なバイト順比較（memcmp）となり、
      比較処理が極めて高速である。
    - sid は意味的な順序を必要としない識別子であるため、
      COLLATE "C" の指定により性能・安定性の両面で最適な設計となる。
```
## parent_chunks / child_chunks
```
親子検索用テーブル。
child_chunksにはembeddingとして1536次元のベクトルを保存。
embedding modelにtext-embedding-3-smallを使用するので次元を合わせている。
また、一般的に1536次元がスイートスポットとされているの事も理由の一つ。
```

## threads / messages
```
会話識別用とその中身。
会話履歴の削除は理論削除とするので、threadsにshow_historyカラムを追加。
```

## system_log
```
winstonで取得するログ保存用。
```