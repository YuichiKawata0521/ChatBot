# 分析用ダッシュボード定義
本分析ページでは、指標は全体傾向の把握を主目的とし、
部署別の比較・ランキングは Overview ページで行う。
分析ページでは、必要に応じて部署フィルターを適用し、
特定部署に絞った時系列・行動分析を行う。
## 全体像
[ フィルターエリア ]  
期間 | 部署 | RAG | ユーザー属性 | その他

[ セクション1: 利用・定着 ]  
折れ線 / 積み上げ

[ セクション2: RAG分析 ]  
ヒット率・文書ランキング

[ セクション3: コスト分析 ]  
推移・部門別

[ セクション4: エラー・品質 ]  
レスポンス・失敗率

**各セクションの役割**
| セクション | 役割      |
| ----- | ------- |
| 1     | 利用状況・定着 |
| 2     | RAGの有効性 |
| 3     | コスト管理   |
| 4     | 品質・障害兆候 |

## フィルターエリア
| No. | フィルター名   | UI種別                   | デフォルト値 | 説明                | 備考                                   |
| :-: | -------- | ---------------------- | ------ | ----------------- | ------------------------------------ |
|  1  | 期間       | Date Picker（From / To） | 直近30日  | 集計対象期間を指定する       | HTML `date` 属性を使用。日単位で集計             |
|  2  | 対象部門1    | ドロップダウン                | All    | 第1階層の部門で絞り込み      | 未所属（NULL）を選択肢として含める                  |
|  3  | 対象部門2    | 連動ドロップダウン              | All    | 対象部門1に連動する第2階層部門  | 未所属（NULL）を選択肢として含める                  |
|  4  | 対象部門3    | 連動ドロップダウン              | All    | 対象部門2に連動する第3階層部門  | 未所属（NULL）を選択肢として含める                  |
|  5  | RAG利用有無  | トグル                    | OFF    | RAG利用スレッドの有無で絞り込み | ON: RAG検索を実行したスレッドのみ<br>OFF: 全スレッド対象 |
|  6  | 文章ID     | Searchable Dropdown    | All    | RAGで参照された文書で絞り込み  | document title を候補表示                 |
|  7  | 応答時間レンジ  | スライダー                  | 全範囲    | 応答時間による絞り込み       | 単位：sec<br>maxは99パーセンタイル              |
|  8  | トークン数レンジ | スライダー                  | 全範囲    | 使用トークン数による絞り込み    | 入力＋出力トークン合算                          |
|  9  | エラー有無    | トグル                    | OFF    | エラー発生有無で絞り込み      | HTTPエラー／LLMエラー／タイムアウト等               |

## セクション1: 利用・定着
・DAU/WAU/MAU推移
　- 折れ線で表示し、日次、週次、月次はタブ切替でそれぞれx軸のデフォルトは直近30日、12週間、12か月とする。アクティブユーザー = メッセージ送信を1回以上行ったユーザー。マウスオーバーで当日値と前期間比較を出す。ただし、期間指定があった場合は、x軸はその期間での日次～月次として、週次は月曜～日曜を1週間とする。

・チャット利用・行動分析
　- 上下2段の折れ線として、y軸にメッセージ数とユーザー数、x軸はDAUなどの推移と連動して、日次～月次までとして、x軸のデフォルト値も30日、12週間、12か月とする。上限のx軸は完全同期。マウスオーバーで人数やメッセージ数と、1ユーザーあたりの平均メッセージ数を表示。

・継続率(7日/30日)
　- 重なった棒グラフ。後ろに初回利用ユーザー数(初回メッセージ送信日)、前に7日/30日で再利用したユーザー数。マウスオーバーで詳細人数(初回ユーザー数と再利用数)と継続率%を表示。

## セクション2: RAG分析
1. 分子の定義
messagesテーブル内にRAGモードを使用した場合、document_idを保存するようにする予定です。
従って、文章検索モード利用メッセージ数は、document_idでgroup byして算出します。

2. 分母の定義
これはuserメッセージのみとします(userとbotは1対1の関係の為)

3-1 参照回数
1に記載の通り、メッセージとdocument_idが紐づいているので、参照回数はメッセージ単位とします

3-3 ヒット率
ヒット率 =　※類似度スコア0.7以上のチャンクが含まれる回答をヒットと定義

4. 追加検討
RAG未ヒット率
　- RAGモードにも関わらず、messagesテーブル内にparent_chunk_idが無い場合を0件とする。


## セクション3: コスト分析
- 折れ線グラフで表示。デフォルトは全部門で、トグルボタンを押すとdep2単位で集計。
　
- モデルの入出力コストをどこかに定義しておいて、入出力トークン数×金額とする。

- 日次、週次、月次推移はこれまでと同様でタブ切替、y軸に金額、横軸にデフォルト集計単位、期間選択でその期間で集計し、マウスオーバーで入力、出力、合計の金額を出す

## セクション4: エラー品質兆候分析
・　エラー率推移  
　- 折れ線グラフ。y軸: エラー発生メッセージ数/総botメッセージ数。横軸は過去30日固定として、エラーの種類で描画。
 詳細は別でログページを作成するので、そちらへ誘導するリンクorボタンを設置する